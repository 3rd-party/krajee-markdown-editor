/*!
 * @copyright Copyright &copy; Kartik Visweswaran, Krajee.com, 2014 - 2016
 * @package krajee-markdown-editor
 * @version 1.0.0
 *
 * A Boostrap styled markdown editor that offers live preview, export, full screen mode, and more features. Can support
 * any markdown parser that can be triggered as an ajax action on the server. Editor defaults are built to support
 * CommonMark spec parsing using markdown-it JS library. Other markdown parsers are configurable (both as a server 
 * call OR a local JS method/library). In addition, the plugin allows  custom button actions and properties to be setup.
 * 
 * Author: Kartik Visweswaran
 * Copyright: 2015, Kartik Visweswaran, Krajee.com
 * For more JQuery plugins visit http://plugins.krajee.com
 * For more Yii related demos visit http://demos.krajee.com
 */!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery"],e):"object"==typeof module&&module.exports?module.exports=e(require("jquery")):e(window.jQuery)}(function(e){"use strict";e.fn.markdownEditorLocales={};var t,o,n,r,i,a,d,l,s,c,u,p,f,h,m,g,v,b,w,x,k,y,P,$,C,M,E,S,T,j,I,H,L,F,U,_,A,R,O;t='<a class="text-info" href="http://plugins.krajee.com/markdown-editor">krajee-markdown-editor</a>',o="[krajee-markdown-editor](http://plugins.krajee.com/markdown-editor)",n="",r=".markdownEditor",i={click:"click"+r,input:"input"+r,change:"change"+r,focus:"focus"+r,blur:"blur"+r,keyup:"keyup"+r,keydown:"keydown"+r,resize:"resize"+r,reset:"reset"+r,scroll:"scroll"+r,touchstart:"touchstart"+r,mouseover:"mouseover"+r,modalShown:"shown.bs.modal"+r,modalHidden:"hidden.bs.modal"+r,buttonPress:"buttonPress"+r,beforePreview:"beforePreview"+r,successPreview:"successPreview"+r,emptyPreview:"emptyPreview"+r,errorPreview:"errorPreview"+r},a='<div class="md-editor" tabindex="0">{header}<table class="md-input-preview"><tr><td class="md-input-cell">{input}</td><td class="md-preview-cell">{preview}</td></tr></table>{footer}{dialog}</div>',d='<div class="md-header"><div class="md-toolbar-header-r btn-toolbar pull-right">{toolbarHeaderR}</div><div class="md-toolbar-header-l btn-toolbar">{toolbarHeaderL}</div><div class="clearfix"></div></div>',l='<div class="md-preview" tabindex="0"></div>',s='<div class="md-footer"><div class="md-toolbar-footer-r btn-toolbar pull-right">{toolbarFooterR}</div><div class="md-toolbar-footer-l btn-toolbar">{toolbarFooterL}</div><div class="clearfix"></div></div>',c='<div class="md-dialog modal fade" tabindex="-1" role="dialog"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="md-dialog-title modal-title"></h4></div><div class="modal-body"><input class="md-dialog-input form-control"><div class="md-dialog-content"></div></div><div class="modal-footer"><button type="button" class="md-dialog-cancel btn btn-default" data-dismiss="modal"><i class="fa fa-remove"></i> </button><button type="button" class="md-dialog-ok btn btn-primary" data-dismiss="modal"><i class="fa fa-check"></i> </button></div></div></div>',u="> - - -\n> Markdown Export\n> ===============\n> *Generated {today} by {credits}*\n> - - -\n\n",f='<!DOCTYPE html><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge;chrome=1"/>',p='{exportPrependCssJs}<style>body{margin:20px;padding:20px;border:1px solid #ddd;border-radius:5px;}th[align="right"]{text-align:right!important;}th[align="center"]{text-align:center!important;}</style>',h='<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">',m='<ul><li><p>You may follow the <a href="http://spec.commonmark.org/" target="_blank">CommonMark spec</a> and <a href="https://github.com/markdown-it/markdown-it">markdown-it</a> syntax for writing your markdown text.</p></li><li><p>In order to use the formatting buttons on the toolbar, you typically need to highlight a text within the editor on which the formatting is to be applied. You can also undo the format action on the highlighted text by clicking the button again (for most buttons).</p></li><li><p>Keyboard access shortcuts for buttons:</p>{accessKeys}</li></ul>',x={undo:"undo",redo:"repeat",bold:"bold",italic:"italic",ins:"underline",del:"strikethrough",sup:"superscript",sub:"subscript",mark:"eraser",paragraph:"paragraph",newline:"text-height",heading:"header",link:"link",image:"picture-o",indent:"indent",outdent:"outdent",ul:"list-ul",ol:"list-ol",dl:"th-list",footnote:"sticky-note-o",blockquote:"quote-right",code:"code",codeblock:"file-code-o",hr:"minus",emoji:"smile-o",fullscreen:"arrows-alt",hint:"question-circle",modePreview:"search",modeEditor:"edit",modeSplit:"arrows-h","export":"download",exportHtml:"file-text",exportText:"file-text-o"},y={undo:"z",redo:"y",bold:"[",italic:"]",ins:"+",del:"x",sup:"~",sub:"^",mark:"=",paragraph:"p",newline:"0",heading1:"1",heading2:"2",heading3:"3",heading4:"4",heading5:"5",heading6:"6",link:"l",image:"p",indent:"i",outdent:"o",ul:"u",ol:"v",dl:"w",footnote:"n",blockquote:"q",code:"c",codeblock:"b",hr:"-",emoji:"`",fullscreen:".",hint:"?",modeEditor:"(",modePreview:")",modeSplit:"_",exportHtml:"h",exportText:"t"},k={undo:"Undo",redo:"Redo",bold:"Bold",italic:"Italic",ins:"Inserted Text",del:"Strike Through",sup:"Superscript",sub:"Subscript",mark:"Highlighted Text",paragraph:"Paragraph",newline:"Append line break",heading:"Heading",link:"Hyperlink",image:"Image Link",indent:"Indent Text",outdent:"Outdent Text",ul:"Unordered List",ol:"Ordered List",dl:"Definition List",footnote:"Footnote",blockquote:"Block Quote",code:"Inline Code",codeblock:"Code Block",hr:"Horizontal Line",emoji:"Emojis / Emoticons",fullscreen:"Toggle full screen mode",hint:"Usage Hints",modeEditor:"Editor mode",modePreview:"Preview mode",modeSplit:"Split mode","export":"Export content",exportHtml:"Export as HTML",exportText:"Export as Text"},P={"export":"Export",exportHtml:"HTML",exportText:"Text"},$={link:{title:"Insert Hyperlink",placeholder:"http://"},image:{title:"Insert Image Link",placeholder:"http://"},ol:{title:"Ordered List Starting Number",placeholder:"Integer starting from 1"},codeblock:{title:"Enter code language",placeholder:"e.g. html, php, js"}},C={bold:{before:"**",after:"**","default":"**(bold text here)**"},italic:{before:"_",after:"_","default":"_(italic text here)_"},ins:{before:"++",after:"++","default":"_(inserted text here)_"},del:{before:"~~",after:"~~","default":"_(strikethrough text here)_"},mark:{before:"==",after:"==","default":"_(marked text here)_"},sup:{before:"^",after:"^","default":"_(superscript text here)_"},sub:{before:"~",after:"~","default":"_(subscript text here)_"},paragraph:{before:"\n",after:"\n","default":"\n(paragraph text here)\n",inline:!0},newline:{before:n,after:"  "},heading1:{before:"# ","default":"# (heading 1 text here)",inline:!0},heading2:{before:"## ","default":"## (heading 2 text here)",inline:!0},heading3:{before:"### ","default":"### (heading 3 text here)",inline:!0},heading4:{before:"#### ","default":"#### (heading 4 text here)",inline:!0},heading5:{before:"##### ","default":"##### (heading 5 text here)",inline:!0},heading6:{before:"###### ","default":"###### (heading 6 text here)",inline:!0},indent:function(t){var o,n="  ";return t.indexOf("\n")<0?t=n+t:(o=t.split("\n"),e.each(o,function(e,t){o[e]=n+t}),t=o.join("\n")),t},outdent:function(t){var o,n="  ";return t.indexOf("\n")<0&&t.substr(0,2)===n?t=t.slice(2):(o=t.split("\n"),e.each(o,function(e,t){o[e]=t,t.substr(0,2)===n&&(o[e]=t.slice(2))}),t=o.join("\n")),t},link:function(e){return function(t){return w(t)||("ftp://"!==t.substring(0,6)&&"http://"!==t.substring(0,7)&&"https://"!==t.substring(0,8)&&(t="http://"+t),e="["+e+"]("+t+")"),e}},image:function(e){return function(t){return w(t)||("ftp://"!==t.substring(0,6)&&"http://"!==t.substring(0,7)&&"https://"!==t.substring(0,8)&&(t="http://"+t),e="!["+e+"]("+t+")"),e}},ul:{before:"- ",after:n},ol:function(t){var o,r;return function(i){return w(i)?n:(T(i)||(i=1),t.indexOf("\n")<0?t=I(t,i+". ",n):(o=parseInt(i),r=t.split("\n"),e.each(r,function(e,t){r[e]=I(t,o+". ",n),o++}),t=r.join("\n")),t)}},dl:function(t){var o,r,i;return t.indexOf("\n")>0?(o=1,i=t.split("\n"),e.each(i,function(e,t){r=o%2===0?":    ":n,i[e]=I(t,r,n),o++}),t=i.join("\n")):t+="\n:    \n",t},footnote:function(t){var o,r,i,a="Enter footnote ",d=n;return t.indexOf("\n")<0?(d="[^1]: "+a+"1\n",t=I(t,n,a+"[^1]")+"\n"+d):(o=1,i=t.split("\n"),e.each(i,function(e,t){r="[^"+o+"]",i[e]=I(t,n,r+"  "),d=d+r+": "+a+o+"\n",o++}),t=i.join("\n")+"  \n\n"+d),t},blockquote:{before:"> ",after:"  "},code:{before:"`",after:"`",inline:!0},codeblock:function(e){return function(t){return w(t,!0)&&(t=n),I(e,"~~~"+t+" \n","\n~~~  \n")}},hr:{before:n,after:"\n- - -",inline:!0}},M={exportText:{ext:"txt",uri:"data:text/plain;base64,"},exportHtml:{ext:"htm",uri:"data:text/html;base64,"}},E=function(e){return void 0===e?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")},S=function(e){return void 0===e?"":F(encodeURIComponent(e))},g=function(t){return e(document.createElement(t))},v=function(e,t){t&&e.removeClass(t).addClass(t)},b=function(){return Math.round((new Date).getTime()+100*Math.random())},w=function(t,o){return null===t||void 0===t||0===t.length||o&&e.trim(t)===n},T=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},j=function(e,t){return void 0===t&&(t="s"),e.replace(new RegExp("["+t+"]+$"),"")},I=function(e,t,o){var n=t.length,r=o.length,i=e;return n>0&&(i=i.slice(0,n)===t?i.slice(n):t+i),r>0&&(i=i.slice(-r)===o?i.slice(0,-r):i+o),i},H=function(t,o,n){var r=t,i=[];return r.indexOf("\n")<0?r=I(t,o,n):(i=t.split("\n"),e.each(i,function(e,t){i[e]=I(j(t),o,n+"  ")}),r=i.join("\n")),r},L=function(t,o,n){var r,i;if(t.setSelectionRange){if(t.focus(),t.setSelectionRange(o,n),t.scrollTop=0,o>100){r=document.createElement("pre"),t.parentNode.appendChild(r),i=window.getComputedStyle(t,""),r.style.visibility="hidden",r.style.lineHeight=i.lineHeight,r.style.fontFamily=i.fontFamily,r.style.fontSize=i.fontSize,r.style.padding=0,r.style.border=i.border,r.style.outline=i.outline,r.style.overflow="scroll",r.style.letterSpacing=i.letterSpacing;try{r.style.whiteSpace="-moz-pre-wrap"}catch(a){}try{r.style.whiteSpace="-o-pre-wrap"}catch(a){}try{r.style.whiteSpace="-pre-wrap"}catch(a){}try{r.style.whiteSpace="pre-wrap"}catch(a){}r.textContent=e(t).val().substring(0,o-100),t.scrollTop=r.scrollHeight,r.parentNode.removeChild(r)}}else if(t.createTextRange){var d=t.createTextRange();d.collapse(!0),d.moveEnd("character",n),d.moveStart("character",o),d.select()}},F=function(e){return e.replace(/%([0-9A-F]{2})/gi,function(e,t){return String.fromCharCode(parseInt(t,16))})},U=function(e,t){e&&e.isDefaultPrevented()||t()},_=function(){var e=0;return function(t,o){clearTimeout(e),e=setTimeout(t,o||250)}}(),A=function(){this.init()},A.prototype={constructor:A,init:function(){var e=this;e.commands=[],e.stackPosition=-1,e.savePosition=-1},execute:function(e){var t=this;t._clearRedo(),e.execute(),t.commands.push(e),t.stackPosition++,t.changed()},undo:function(){var e=this;e.commands[e.stackPosition].undo(),e.stackPosition--,e.changed()},canUndo:function(){var e=this;return e.stackPosition>=0},redo:function(){var e=this;e.stackPosition++,e.commands[e.stackPosition].redo(),e.changed()},canRedo:function(){var e=this;return e.stackPosition<e.commands.length-1},save:function(){var e=this;e.savePosition=e.stackPosition,e.changed()},dirty:function(){var e=this;return e.stackPosition!==e.savePosition},_clearRedo:function(){var e=this;e.commands=e.commands.slice(0,e.stackPosition+1)},changed:function(){}},R=function(e,t,o,n,r){var i=this;i.textarea=e,i.oldValue=t,i.newValue=o,i.oldPos=n,i.newPos=r},R.prototype={constructor:R,execute:function(){},undo:function(){var e=this,t=e.textarea,o=t[0];t.val(e.oldValue),L(o,e.oldPos[0],e.oldPos[1])},redo:function(){var e=this,t=e.textarea,o=t[0];t.val(e.newValue),L(o,e.newPos[0],e.newPos[1])}},O=function(t,o){var n=this;n.$element=e(t),n.init(o)},O.prototype={constructor:O,init:function(t){var o=this,n=o.$element;e.each(t,function(e,t){o[e]=t}),n.attr("id")||n.attr("id",b()),o.$form=o.initForm(),o.$element.attr("rows",o.rows),o.buttonIcons=e.extend(!0,{},x,o.buttonIcons),o.buttonTitles=e.extend(!0,{},k,o.buttonTitles),o.buttonLabels=e.extend(!0,{},P,o.buttonLabels),o.buttonPrompts=e.extend(!0,{},$,o.buttonPrompts),o.buttonAccessKeys=e.extend(!0,{},y,o.buttonAccessKeys),o.buttonActions=e.extend(!0,{},C,o.buttonActions),console.log(o.buttonActions),o.exportConfig=e.extend(!0,{},M,o.exportConfig),o.defaultInputHeight=o.$element.height(),w(o.parserUrl)&&void 0===o.parserMethod&&window.markdownit&&(o.parserMethod=function(t){var n=window.markdownit(o.markdownItOptions);return w(o.markdownItDisabledRules)||n.disable(o.markdownItDisabledRules),e.each(o.markdownItPlugins,function(e,t){n.use(window[e],t)}),n.renderer.rules.emoji=function(e,t){return o.useTwemoji&&window.twemoji?window.twemoji.parse(e[t].content):'<span class="md-emoji">'+e[t].content+"</span>"},n.renderer.rules.paragraph_open=n.renderer.rules.heading_open=function(e,t,o,n,r){var i;return e[t].map&&0===e[t].level&&(i=e[t].map[0],e[t].attrJoin("class","md-line"),e[t].attrSet("data-line",String(i))),r.renderToken(e,t,o,n,r)},n.render(t)}),o.enableSplitMode&&void 0===o.enableLivePreview&&(o.enableLivePreview=!0),o.render(),o.$preview.height(o.defaultInputHeight),o.startFullScreen&&o.toggleFullScreen(),o.reset(),o.listen()},handleEvent:function(t,o,n){var r=this;t.off(o).on(o,e.proxy(r[n],r))},listen:function(){var t=this,o=t.$container,n=t.$element,r=t.$preview,a=n.closest("form"),d=i.resize,l=i.reset,s=i.keyup,c=i.buttonPress,u=i.focus,p=i.blur,f=i.change,h=i.click,m=i.touchstart+" "+i.mouseover,g=t.$editor.find(".md-emoji-search"),v=i.keydown;t.parseButtons(),o.find(".dropdown-toggle").dropdown(),t.handleEvent(t.$dialogInput,v,"keydownDialog"),t.handleEvent(n,u,"focus"),t.handleEvent(r,u,"focus"),t.handleEvent(n,p,"blur"),t.handleEvent(r,p,"blur"),t.handleEvent(t.$editor,u,"focusContainer"),t.handleEvent(e(window),d,"resizeWindow"),a.length&&t.handleEvent(a,l,"reset"),t.handleEvent(t.$btnUndo,h,"undo"),t.handleEvent(t.$btnRedo,h,"redo"),t.handleEvent(n,s,"keyup"),t.handleEvent(n,c,"buttonPress"),t.handleEvent(n,m,"mouseoverEditor"),t.handleEvent(r,m,"mouseoverPreview"),t.handleEvent(t.$modeInput,f,"modeChange"),g.length&&(t.handleEvent(g.find("input"),s,"emojiSearch"),t.handleEvent(g.find(".md-close"),h,"emojiSearchClose"))},resizeWindow:function(t){var o,n,r=this,i=r.$container,a=r.$preview;U(t,function(){i.hasClass("md-fullscreen-overlay")&&r.resizeFullScreen(),o=a.find(".md-preview-message"),o.length&&(n=e(window).width()<640?"100%":.5*a.width(),o.width(n))})},emojiSearch:function(t){var o=this,n=o.$editor.find(".md-emoji-search"),r=n.find("input"),i=r.val(),a=n.closest("ul");U(t,function(){_(function(){a.find("li").each(function(){var t=e(this),o=t.find("a").attr("data-key");t.hasClass("md-emoji-search")||o&&-1!==o.indexOf(i)?t.show():t.hide()})})})},emojiSearchClose:function(e){var t=this,o=t.$editor.find(".md-emoji-search");U(e,function(){e.stopPropagation(),o.closest("ul").find("li").show(),o.find("input").val("")})},focusContainer:function(e){var t=this;U(e,function(){t.$element.focus()})},focus:function(e){var t=this;U(e,function(){v(t.$editor,"active")})},blur:function(e){var t=this;U(e,function(){t.$editor.removeClass("active")})},clickButton:function(e,o){var n,r,i=this,a=o.data("key"),d=o.hasClass("md-btn-heading"),l=o.hasClass("md-btn-export"),s=o.hasClass("md-btn-emoji");U(e,function(){if(d||l||s){if(e.preventDefault(),l)return void i["export"](a);if(s)return void i.replaceSelected(":"+a+":")}switch(a){case"fullscreen":i.toggleFullScreen();break;case"hint":n=i.getTitle(a)+" <small>"+t+"</small>",i.showPopup(n,i.renderHint());break;default:r=i.process(a),w(r)||i.replaceSelected(r)}})},modeChange:function(e){var t,o=this;U(e,function(){t=o.$mode.find('input:radio[name="mdMode"]:checked').val()||"modeEditor",o.toggleMode(t),o.currentMode=t.substr(4).toLowerCase()})},reset:function(e){var t=this,o=t.$element,n=o[0];U(e,function(){setTimeout(function(){t.enableUndoRedo?(t.undoStack=t.resetUndoStack(),t.startValue=o.val(),t.startPos=[n.selectionStart,n.selectionEnd]):t.undoStack=null,t.$preview.is(":visible")&&setTimeout(function(){t.generatePreview()},1)},1)})},undo:function(e){var t=this;t.enableUndoRedo&&U(e,function(){t.undoStack.undo(),t.scrollMap=null,t.enableLivePreview&&t.generatePreview()})},redo:function(e){var t=this;t.enableUndoRedo&&U(e,function(){t.undoStack.redo(),t.scrollMap=null,t.enableLivePreview&&t.generatePreview()})},keyup:function(e){var t=this,o=t.$element,n=o[0],r=t.undoStack;U(e,function(){t.enableLivePreview&&t.$preview.is(":visible")&&_(t.generatePreview()),t.enableUndoRedo&&_(function(){var e=o.val(),i=[n.selectionEnd,n.selectionEnd];e!==t.startValue&&(r.execute(new R(o,t.startValue,e,t.startPos,i)),t.startValue=e,t.startPos=i,t.scrollMap=null)})})},keydownDialog:function(e){var t=this;U(e,function(){13===e.keyCode&&(t.$dialogOk.trigger("click"),e.stopPropagation(),e.preventDefault())})},buttonPress:function(e,t,o){var n,r=this,i=r.$element;U(e,function(){r.enableUndoRedo&&(n=i.val(),r.startPos=t,r.undoStack.execute(new R(i,r.startValue,n,r.startPos,o)),r.startValue=n,r.startPos=o),r.enableLivePreview&&r.$preview.is(":visible")&&r.generatePreview()})},_mouseover:function(e,t){var o=this,n=o.$element,r=o.$preview,a=i.scroll;e&&e.isDefaultPrevented()||!n.is(":visible")||!r.is(":visible")||("editor"===t?(r.off(a),n.on(a,function(){o.syncPreviewScroll()})):(n.off(a),r.on(a,function(){o.syncInputScroll()})))},mouseoverEditor:function(e){var t=this;U(e,function(){t._mouseover(e,"editor")})},mouseoverPreview:function(e){var t=this;U(e,function(){t._mouseover(e,"preview")})},buildScrollMap:function(){var t,o,n,r,i,a,d,l=this,s=l.$element,c=l.$preview,u=0,p=[],f=[],h=[];if(!l.enableScrollSync)return"";for(d=g("div").css({position:"absolute",visibility:"hidden",height:"auto",width:s[0].clientWidth,"font-size":s.css("font-size"),"font-family":s.css("font-family"),"line-height":s.css("line-height"),"white-space":s.css("white-space")}).appendTo("body"),o=c[0].scrollTop-c.offset().top,s.val().split("\n").forEach(function(e){var t,o;return p.push(u),0===e.length?void u++:(d.text(e),t=parseFloat(d.css("height")),o=parseFloat(d.css("line-height")),void(u+=Math.round(t/o)))}),d.remove(),p.push(u),a=u,t=0;a>t;t++)h.push(-1);for(f.push(0),h[0]=0,c.find(".md-line").each(function(t,n){var r=e(n),i=r.data("line");""!==i&&(i=p[i],0!==i&&f.push(i),h[i]=Math.round(r.offset().top+o))}),f.push(a),h[a]=c[0].scrollHeight,n=0,t=1;a>t;t++)-1===h[t]?(r=f[n],i=f[n+1],h[t]=Math.round((h[i]*(t-r)+h[r]*(i-t))/(i-r))):n++;return h},syncInputScroll:function(){var e,t,o,n=this,r=n.$element,i=n.$preview,a=n.scrollMap,d=i[0].scrollTop,l=parseFloat(r.css("line-height"));if(a||(a=n.scrollMap=n.buildScrollMap()),e=Object.keys(a),!(e.length<1)){for(o=e[0],t=1;t<e.length&&a[e[t]]<d;t++)o=e[t];r.stop(!0).animate({scrollTop:l*o},100,"linear")}},syncPreviewScroll:function(){var e,t=this,o=t.$element,n=t.$preview,r=t.scrollMap,i=parseFloat(o.css("line-height")),a=Math.floor(o[0].scrollTop/i);r||(r=t.scrollMap=t.buildScrollMap()),e=r[a],n.stop(!0).animate({scrollTop:e},100,"linear")},resetUndoStack:function(){var e=this,t=new A;return e.startValue=e.$element.val(),e.startPos=[0,0],t.changed=function(){e.disableButton(e.$btnUndo,!t.canUndo()),e.disableButton(e.$btnRedo,!t.canRedo())},t.changed(),t},parseButtons:function(){var t=this,o=t.$container,n=i.click;o.find(".md-btn,.md-btn-heading,.md-btn-export,.md-btn-emoji").each(function(){var o=e(this);o.off(n).on(n,function(e){t.clickButton(e,o)})})},getSelected:function(){var e=this,t=e.$element,o=t.val(),n=t[0];return o.substring(n.selectionStart,n.selectionEnd)},replaceSelected:function(e){var t=this,o=t.$element,n=o.val(),r=o[0],a=r.selectionStart,d=e.length,l=r.selectionEnd,s=n.substring(0,a)+e+n.substring(l),c=a+d;o.val(s).trigger(i.buttonPress,[[a,l],[a,c]]),L(r,a,c)},destroy:function(){var t=this,o=t.$element,n=t.$container,i=t.inputCss;o.insertBefore(n).off(r),e(window).off(r),i&&o.removeClass(i).show(),n.remove()},getLayout:function(e){return this.templates[e]||n},initForm:function(){var t,o,n,r=this,i=e("#"+r.exportFormId);return r.exportFormId&&i.length||(i=g("form")),i.attr({action:r.exportUrl,method:"post",target:"_blank"}),t=g("input").attr({type:"hidden",name:"export_type"}),o=g("input").attr({type:"hidden",name:"export_filename",value:r.exportFileName}),n=g("textarea").attr({name:"export_content"}).val(r.noDataMsg),i.append(t,o,n).hide()},showPopup:function(e,t){var o=this,n=i.modalShown;o.$dialogTitle.html(e),o.$dialogContent.html(t).show(),o.$dialogInput.hide(),o.$dialogClose.show(),o.$dialogHeader.show(),o.$dialogFooter.hide(),o.$dialogOk.off(i.click),o.$dialog.modal("show"),o.$dialog.off(n).on(n,function(){o.$dialogClose.focus(),o.$dialog.off(n)})},showDialog:function(e,t){var o,r=this,a=r.buttonPrompts[e],d=a.title||n,l=r.renderIcon(e),s=a.placeholder||n,c=i.modalShown;r.$dialogTitle.html(l?l+" "+d:d),r.$dialogContent.hide(),r.$dialogClose.show(),r.$dialogHeader.show(),r.$dialogFooter.show(),r.$dialogInput.show().val(n).attr("placeholder",s),r.$dialogOk.off(i.click).on(i.click,function(){o=t(r.$dialogInput.val()),w(o)||r.replaceSelected(o)}),r.$dialog.modal("show"),r.$dialog.off(c).on(c,function(){r.$dialogInput.focus(),r.$dialog.off(c)})},raise:function(t,o,n){var i=this,a=e.Event(t+r);return n=n||i.$element,o?n.trigger(a,o):n.trigger(a),!a.isDefaultPrevented()},showPreviewMsg:function(e){var t=this,o=t.$preview,n=t.getAlert(e,t.previewErrorTitle);o.html('<div class="md-preview-message">'+n+"</div>"),o.find(".md-preview-message").width(.5*o.width()),o.find(".md-alert").hide().fadeIn("slow")},disableButton:function(e,t){e.attr("disabled",t||!1)},hasInvalidConfig:function(e){var t=this,o=t[e+"Url"],n=t[e+"Method"],r=w(o),i=w(n),a=typeof n;return"export"===e&&t.enableExportDataUri?!1:r&&i||!i&&"function"!==a&&"object"!==a},parseOutput:function(t){var o=this,n=o.postProcess;return n&&("function"==typeof n?t=n(t):"object"==typeof n&&e.each(n,function(e,o){t=t.split(e).join(o)})),t},generatePreview:function(t,o){var n=this,r=n.$element,i=n.$preview,a=n.parserUrl,d=n.parserMethod,l=n.getProgress(n.previewProgressMsg);return void 0===t&&(t=r.val()),w(a)?(t="function"==typeof d?d(t):new d(t),t=n.parseOutput(t),o?t:void i.html(t)):(e.ajax({type:"POST",url:a,dataType:"json",data:{source:t},beforeSend:function(e){n.raise("beforePreview",[e])&&i.html(l)},success:function(e,t,o){var r=!w(e,!0);r&&n.raise("successPreview",[e,t,o])&&(e=n.parseOutput(e),i.html(e)),!r&&n.raise("emptyPreview",[e,t,o])&&n.showPreviewMsg(n.emptyPreviewMsg)},error:function(e,t,o){n.raise("errorPreview",[e,t,o])&&n.showPreviewMsg(n.errorPreviewMsg)}}),null)},output:function(){var e,t=this,o=t.$element,r=t.$preview,a=o.val(),d=!0,l=0,s=i.successPreview,c=i.emptyPreview+" "+i.errorPreview;if(w(a)||t.hasInvalidConfig("parser"))return n;if(e=t.generatePreview(a,!0),w(t.parserUrl))return e;for(;d&&l<t.outputParseTimeout;)_(function(){o.off(s).on(s,function(){d=!1,e=r.html()}).off(c).on(c,function(){d=!1,e=""}),l+=150},150);return e},toggleMode:function(e){var t=this,o=t.$element,n=o.val(),r=t.$container,i=t.currentMode||"modeEditor",a=r.find(".md-input-preview"),d=function(){"editor"===i&&(t.$preview.html(t.getProgress(t.loadingMsg)),setTimeout(function(){t.generatePreview(),t.$mode.focus()},50))};if(w(n)||t.hasInvalidConfig("parser"))return void t.showPopupAlert(t.getTitle("mode"),w(n)?t.noDataMsg:t.noPreviewUrlMsg);switch(r.removeClass("md-only-preview"),a.removeClass("md-editor-mode md-preview-mode md-split-mode"),e){case"modeEditor":v(a,"md-editor-mode");break;case"modePreview":v(a,"md-preview-mode"),v(r,"md-only-preview"),d();break;case"modeSplit":v(a,"md-split-mode"),d()}},toggleFullScreen:function(){var e=this,t=e.$container,o=e.$element,n=e.$preview;t.hasClass("md-fullscreen-overlay")?(t.removeClass("md-fullscreen-overlay"),o.height(e.defaultInputHeight),n.height(e.defaultInputHeight)):(t.addClass("md-fullscreen-overlay"),e.resizeFullScreen()),n.is(":visible")?n.focus():o.focus()},resizeFullScreen:function(){var t=this,o=t.$container,n=t.$element,r=o.find(".md-header"),i=o.find(".md-footer"),a=e(window).height()-r.outerHeight(!0)-i.outerHeight(!0)-(n.outerHeight(!0)-n.height());n.height(a),t.$preview.height(a)},process:function(e){var t,o,r,i,a=this,d=a.$element,l=a.getSelected(),s=l.length,c=a.buttonActions[e];return d.focus(),"undo"===e||"redo"===e?"":c?"function"==typeof c?(t=c(l),"function"==typeof t?(a.showDialog(e,t),n):t):"object"!=typeof c||void 0===c.before&&void 0===c.after?n:(r=w(c.before)?n:c.before,i=w(c.after)?n:c.after,o=c["default"],t=c.inline?I(l,r,i):H(l,r,i),o?s>0?t:o:t):n},download:function(e,t){var o=this,n=o.$form,r=o.exportConfig[e],i=g("a"),a=r.ext||"",d=r.uri||"";return w(o.exportUrl)?(d+=window.btoa(t),i.attr({href:d,target:"_blank",download:o.getFileName(e)}).insertAfter(n),i[0].click(),void i.remove()):(n.find('[name="export_type"]').val(a),n.find('[name="export_content"]').val(t),void n.submit())},getLabel:function(e){var t=this;return t.renderIcon(e)+" "+(t.buttonLabels[e]||n)},getTitle:function(e){var t=this;return t.renderIcon(e)+" "+(t.buttonTitles[e]||n)},getProgress:function(e){return'<div class="md-loading">'+e+"</div>"},getAlert:function(e,t,o){var n=this;return t=t?"<h4>"+(o?"":n.alertMsgIcon)+t+"</h4>":"",'<div class="'+n.alertMsgCss+' md-alert">'+t+e+"</div>"},showPopupAlert:function(e,t){var o=this,n=o.$dialog.find(".modal-body"),r=o.alertFadeDuration,a=i.modalShown,d=i.modalHidden;o.showPopup("",o.getAlert(t,e,!0)),o.$dialogHeader.hide(),o.$dialogFooter.hide(),o.$dialogClose.hide(),n.addClass("md-zero-pad"),o.$dialog.off(a).on(a,function(){r?setTimeout(function(){o.$dialog.modal("hide").off(a)},r):o.$dialog.modal("hide").off(a)}),o.$dialog.off(d).on(d,function(){n.removeClass("md-zero-pad"),o.$dialog.off(a).off(d),o.$element.focus()})},getHtmlContent:function(e){var t=this,o=t.exportPrependCssJs;return"<html><head>"+t.getLayout("htmlMeta")+t.getLayout("exportCssJs").replace("{exportPrependCssJs}",o)+"</head><body>"+e+"</body></html>"},"export":function(t){var n,r=this,i=r.$element.val(),a=r.getTitle("exportText"),d=r.getTitle("exportHtml"),l=r.noDataMsg,s=r.exportErrorMsg,c=r.noExportUrlMsg,u=r.today||new Date;return w(i)||r.hasInvalidConfig("parser")||r.hasInvalidConfig("export")?void r.showPopupAlert("exportText"===t?a:d,w(i)?l:c):(i=r.getLayout("exportHeader").replace("{today}",u).replace("{credits}",o)+i,"exportHtml"!==t?void r.download("exportText",i):w(r.parserUrl)?(n=S(r.generatePreview(i,!0)),void r.download("exportHtml",r.getHtmlContent(n))):void e.ajax({type:"POST",url:r.parserUrl,dataType:"json",data:{source:i},beforeSend:function(e){r.raise("beforeExportHtm",[e])&&r.showPopup(d,r.getProgress(r.exportProgressMsg))},success:function(e,o,n){r.raise("successExportHtm",[e,o,n])&&(r.$dialog.modal("hide"),e?r.download(t,r.getHtmlContent(e)):r.showPopupAlert(d,s))},error:function(e,t,o){r.raise("errorExportHtm",[e,t,o])&&r.showPopupAlert(d,s)}}))},renderIcon:function(e){var t=this,o=e&&t.buttonIcons[e]||n;return o?'<span class="'+t.buttonIconCssPrefix+o+'"></span>':n},render:function(){var t,o,r,i,a=this,d=a.$element,l=g("div").addClass("md-container"),s=a.getLayout("main"),c="md-editor-input-temporary",u=d.attr("id")+"-container",p=a.theme||"krajee";return s?(v(l,"md-"+p),o=s.replace("{input}",'<div class="'+c+'"></div>').replace("{header}",a.renderHeader()).replace("{footer}",a.renderFooter()).replace("{preview}",a.getLayout("preview")).replace("{dialog}",a.getLayout("dialog")),l.attr("id",u).insertBefore(d).html(o),t=l.find("."+c),d.insertBefore(t),v(d,a.inputCss),t.remove(),a.$container=l,a.$editor=l.find(".md-editor"),a.$preview=l.find(".md-preview"),a.$btnPreview=l.find(".md-btn-preview"),a.$btnUndo=l.find(".md-btn-undo"),a.$btnRedo=l.find(".md-btn-redo"),a.$dialog=l.find(".md-dialog"),a.$dialogTitle=a.$dialog.find(".md-dialog-title"),a.$dialogInput=a.$dialog.find(".md-dialog-input"),a.$dialogContent=a.$dialog.find(".md-dialog-content"),a.$dialogCancel=a.$dialog.find(".md-dialog-cancel").append(a.dialogCancelText),a.$dialogOk=a.$dialog.find(".md-dialog-ok").append(a.dialogOkText),a.$dialogClose=a.$dialog.find(".close"),a.$dialogHeader=a.$dialog.find(".modal-header"),a.$dialogFooter=a.$dialog.find(".modal-footer"),a.$mode=l.find(".md-btn-mode"),a.$modeInput=a.$mode.find('input:radio[name="mdMode"]'),a.$inputPreview=l.find(".md-input-preview"),a.$inputCell=l.find(".md-input-cell"),a.$previewCell=l.find(".md-preview-cell"),a.previewModeTitle&&a.$editor.find(".md-toolbar-header-l").prepend('<div class="md-preview-mode-title">'+a.previewModeTitle+"</div>"),"preview"===a.defaultMode||a.enableSplitMode&&"split"===a.defaultMode||(a.defaultMode="editor"),a.currentMode=a.defaultMode,v(a.$inputPreview,"md-"+a.defaultMode+"-mode"),e.each(a.dropUp,function(e,t){t&&l.find('button[data-key="'+e+'"]').parent().addClass("dropup")}),r=d.closest("form"),i=r.length?r:l,void a.$form.insertAfter(i)):n},_toolbar:function(t){var o=this,n=[];return e.each(o[t],function(t,o){var r=e.isArray(o)?o:[o];e.merge(n,r)}),n},getValidButtons:function(){var t=this,o=t._toolbar("toolbarHeaderL");return e.merge(o,t._toolbar("toolbarHeaderR")),e.merge(o,t._toolbar("toolbarFooterL")),e.merge(o,t._toolbar("toolbarFooterR")),o},renderHint:function(){var t,o,n,r,i,a,d,l=this,s=l.hintText,c="{accessKeys}";return-1===s.indexOf(c)?s:(t='<div class="md-hint-access-keys"><ul>',d=l.getValidButtons(),e.each(l.buttonAccessKeys,function(e,s){i=8===e.length&&"heading"===e.substring(0,7),(-1!==d.indexOf(e)||i||"mode"===e.substring(0,4)||"export"===e.substring(0,6))&&(i?(r=e.substring(7),o=l.renderIcon("heading")+r,n=l.buttonTitles.heading+" "+r):(o=l.renderIcon(e),n=l.buttonTitles[e]),a=l.buttonCss[e]||l.defaultButtonCss,t+='<li title="'+n+'"><p><span class="'+a+'">'+o+"</span></p><p><kbd>ALT</kbd> + <code>"+s+"</code></p></li>")}),t+="</ul></div>",s.replace(c,t))},renderHeader:function(){var e=this,t=e.getLayout("header");return t=e.renderToolbar(t,"toolbarHeaderL"),t=e.renderToolbar(t,"toolbarHeaderR")},renderFooter:function(){var e=this,t=e.getLayout("footer");return t=e.renderToolbar(t,"toolbarFooterL"),t=e.renderToolbar(t,"toolbarFooterR")},renderToolbar:function(t,o){var r=this,i="{"+o+"}",a=n;return-1===t.indexOf(i)?t:(e.each(r[o],function(t,o){e.isArray(o)||(o=[o]),a+='<div class="btn-group" role="group">\n',e.each(o,function(e,t){a+=r.renderButton(t)+"\n"}),a+="</div>\n"}),t.replace("{"+o+"}",a))},getFileName:function(e){var t=this,o=t.exportFileName,n=t.exportConfig[e]&&t.exportConfig[e].ext||"";return n?o+"."+n:o},renderMenuItem:function(e,t){var o,n,r=this,i=g("a"),a=g("div"),d=e+t;return"export"===e?(o=r.buttonTitles[d],n=r.getLabel(d)):(o=r.buttonTitles[e],n=o+" "+t),i.attr({href:"#","class":"md-btn-"+e+" md-btn-"+d,title:o,accesskey:r.buttonAccessKeys[d],"data-key":d}).html(n),n=a.append(i).html(),a.remove(),n},getEmojies:function(){var t=this,o="";return w(t.markdownItEmojies)?"":(o='<li class="md-emoji-search"><span class="md-close">&times;</span><input type="text" class="form-control input-sm" placeholder="'+t.emojiSearchHint+'"></li>',e.each(window.mdEmojies,function(e,n){var r,i,a=":"+E(e)+":",d=window.mdEmojiesShortcuts[e]||"";if(d)for(a+=" or ",r=0;r<d.length;r++)i=E(d[r]),a+=0===r?i:" or "+i;o+='<li><a href="#" class="md-btn-emoji" title="'+a+'" data-key="'+e+'"><span class="md-emoji">'+(t.useTwemoji?window.twemoji.parse(n):n)+"</span></a></li>"}),o)},getModeButton:function(e){var t=this,o=t.buttonCss[e]||t.defaultButtonCss||"",n="",r=e.substr(4).toLowerCase(),i=t.buttonAccessKeys[e]||"";return t.defaultMode===r&&(o+=" active",n=" checked"),'<label class="'+o+'" title="'+t.buttonTitles[e]+'"><input type="radio" value="'+e+'" name="mdMode" autocomplete="off" accesskey="'+i+'"'+n+">"+t.renderIcon(e)+"</label>"},renderButton:function(e){var t,o,r,i,a,d,l,s,c,u,p=this,f=p.buttonTitles,h="mode"===e||void 0!==p.buttonIcons[e]||void 0!==p.buttonActions[e],m=p.buttonLabels,v="md-btn-"+e,b=p.buttonAccessKeys;if(!h||!p.enableUndoRedo&&("undo"===e||"redo"===e||"editor"===e))return n;switch(c=p.buttonCss[e]||p.defaultButtonCss,o=g("div"),t=g("button").attr({type:"button","data-key":e}),r=p.renderIcon(e),i=f[e]||n,a=m[e]||n,i&&t.attr("title",i),("fullscreen"===e||"hint"===e||"mode"===e)&&(v+=" md-btn-special"),"fullscreen"===e&&(r='<span class="md-max-icon">'+r+'</span><span class="md-min-icon">'+p.fullScreenMinimizeIcon+"</span>"),
a=r&&a?r+" "+a:r+a,o.append(t),e){case"heading":case"export":case"emoji":switch(t.html(a+" ").attr({"data-toggle":"dropdown"}).append('<span class="caret"></span>'),u=p.dropdownCss[e]?"dropdown-menu "+p.dropdownCss[e]:"dropdown-menu",s='<ul class="'+u+'">\n',e){case"heading":case"emoji":if(t.addClass(c+" dropdown-toggle md-btn-other"),"emoji"===e){s+=p.getEmojies();break}for(l=1;7>l;l++)d=i+" "+l,s+="<li>"+p.renderMenuItem("heading",l)+"</li>";break;case"export":t.addClass(c+" dropdown-toggle"),s+="<li>"+p.renderMenuItem(e,"Html")+"</li><li>"+p.renderMenuItem(e,"Text")+"</li>"}return s+="</ul>",o.append(s).attr({"class":"btn-group",role:"group"}),o=g("div").append(o),s=o.html(),o.remove(),s;case"mode":return'<div class="btn-group md-btn-mode" data-toggle="buttons">'+p.getModeButton("modeEditor")+p.getModeButton("modePreview")+(p.enableSplitMode?p.getModeButton("modeSplit"):"")+"</div>";default:return t.attr("accesskey",b[e]).html(a).addClass(c+" "+v+" md-btn"),o.html()}}},e.fn.markdownEditor=function(t){var o=Array.apply(null,arguments),n=[];switch(o.shift(),this.each(function(){var r,i,a=e(this),d=a.data("markdownEditor"),l="object"==typeof t&&t,s=l.language||a.data("language")||"en";d||(r="en"===s||w(e.fn.markdownEditorLocales[s])?{}:e.fn.markdownEditorLocales[s],i=e.extend(!0,{},e.fn.markdownEditor.defaults,e.fn.markdownEditorLocales.en,r,l,a.data()),d=new O(this,i),a.data("markdownEditor",d)),"string"==typeof t&&n.push(d[t].apply(d,o))}),n.length){case 0:return this;case 1:return n[0];default:return n}},e.fn.markdownEditor.defaults={language:"en",theme:"krajee",rows:15,defaultMode:"editor",enableUndoRedo:!0,enableExportDataUri:!0,enableSplitMode:!0,enableLivePreview:void 0,enableScrollSync:!0,startFullScreen:!1,templates:{main:a,header:d,preview:l,footer:s,dialog:c,exportHeader:u,htmlMeta:f,exportCssJs:p},toolbarHeaderL:[["undo","redo"],["bold","italic","ins","del","sup","sub","mark"],["paragraph","newline","heading"],["link","image"],["indent","outdent","ul","ol","dl"],["footnote","blockquote","hr"],["code","codeblock"],["emoji"]],toolbarHeaderR:[["fullscreen"]],toolbarFooterL:[["hint"],["export"]],toolbarFooterR:[["mode"]],exportPrependCssJs:h,inputCss:"md-input",defaultButtonCss:"btn btn-default",buttonCss:{hint:"btn btn-info"},dropdownCss:{emoji:"md-emojies-list pull-right"},dropUp:{"export":!0},buttonIconCssPrefix:"fa fa-",buttonIcons:{},buttonAccessKeys:{},parserUrl:n,parserMethod:void 0,markdownItOptions:{html:!1,linkify:!0,typographer:!0,highlight:function(e){return window.hljs?window.hljs.highlightAuto(e).value:e}},markdownItDisabledRules:[],markdownItPlugins:{markdownitDeflist:{},markdownitFootnote:{},markdownitAbbr:{},markdownitEmoji:{},markdownitSub:{},markdownitSup:{},markdownitMark:{},markdownitIns:{},markdownitSmartArrows:{},markdownitCheckbox:{divWrap:!0,divClass:"checkbox",idPrefix:"cbx_"}},markdownItEmojies:window.mdEmojies||{},useTwemoji:!1,exportUrl:n,exportMethod:n,exportFormId:n,today:n,alertMsgIcon:'<i class="fa fa-exclamation-circle"></i> ',alertMsgCss:"alert alert-danger",alertFadeDuration:2e3,outputParseTimeout:18e5,exportConfig:M,fullScreenMinimizeIcon:'<i class="fa fa-compress"></i>',postProcess:{"<table>":'<table class="table table-bordered table-striped">'}},e.fn.markdownEditorLocales.en={noDataMsg:"No valid source data found!",exportFileName:"export",buttonTitles:{},buttonLabels:{},buttonPrompts:{},buttonActions:{},hintText:m,dialogCancelText:"Cancel",dialogOkText:"Ok",previewErrorTitle:"Preview Error",previewModeTitle:"Preview Mode",noPreviewUrlMsg:"Markdown preview processor unavailable. Please contact the system administrator.",emptyPreviewMsg:"No formatted content available for preview.",errorPreviewMsg:"Error generating preview. Please try again later.",previewProgressMsg:"Generating preview ...",noExportUrlMsg:"Export processor unavailable. Please contact the system administrator.",exportProgressMsg:"Generating export file for download ...",exportErrorMsg:"Error generating export. Please try again later.",emojiSearchHint:"Search emojis ...",loadingMsg:"Loading ..."},e.fn.markdownEditor.Constructor=O,e(document).ready(function(){var t=e("textarea.markdown");t.length&&t.markdownEditor()})});